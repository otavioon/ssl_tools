<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Structuring the input &mdash; SSLTools  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Training a Pytorch Lighning model" href="02_training_model.html" />
    <link rel="prev" title="Tutorials" href="../tutorials.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SSLTools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. Structuring the input</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Time-series-dataset-implementations">Time-series dataset implementations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#SeriesFolderCSVDataset"><code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#MultiModalSeriesCSVDataset"><code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Loading-batches-of-data-using-DataLoader">Loading batches of data using DataLoader</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Handling-data-splits-(train,-validation,-and-test)-using-LightningDataModule">Handling data splits (train, validation, and test) using <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="02_training_model.html">2. Training a Pytorch Lighning model</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_training_ssl_model.html">3. Training a self-supervised model: Contrastive Predictive Coding (CPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_using_experiments.html">4. Using Experiments</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_covid_anomaly_detection.html">5. Training an Anomaly Detection Model for Covid Anomaly Detection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../experiments.html">Running Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Programming Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SSLTools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">1. Structuring the input</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/01_structuring_input.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="1.-Structuring-the-input">
<h1>1. Structuring the input<a class="headerlink" href="#1.-Structuring-the-input" title="Link to this heading"></a></h1>
<p>In order to train and test models, we need to structure the input data in a way that is compatible with the model and the framework’s experiments.</p>
<p>For now, this framework is designed to work with time-series data and Pytorch Lightning. Thus, it provides the necessary tools to create <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> and <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> objects, required by Pytorch Lightning to train and test models.</p>
<p>In this notebook, we explain the default data pipeline, which includes: 1. Creating <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> objects, that are responsible for loading the data. 2. Creating <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> objects, that are responsible for batched loading of the data. It encapsulates the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object and provides an iterator to iterate over the data in batches. 3. Creating <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> objects, that are responsible for loading the data and creating the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> and encapsulate it into <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>
objects for training, validation, and test sets.</p>
<section id="Time-series-dataset-implementations">
<h2>Time-series dataset implementations<a class="headerlink" href="#Time-series-dataset-implementations" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object is responsible for loading the data. It is a Pytorch object that is used to load the data and make it available to the model.</p>
<p>Every <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class must implement two methods: <code class="docutils literal notranslate"><span class="pre">__len__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>. The <code class="docutils literal notranslate"><span class="pre">__len__</span></code> method returns the number of samples in the dataset, and the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, given an integer from 0 to <code class="docutils literal notranslate"><span class="pre">__len__</span></code> - 1, returns the corresponding sample from the dataset. The returned type of the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method is not specified, but it is usually a 2-element tuple with the input and the target. The input is the data that will be used to make the predictions, and the target is the data
that the model will try to predict.</p>
<p>The first step when creating a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object is to identify the layout of the data directory and choose the appropriate class to handle it. For now, this framework provides default <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> classes for time-series data, which are the <code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code> and <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code> classes. Both classes assumes that data are stored in CSV files, but with different layouts, to know:</p>
<ul class="simple">
<li><p>A directory with several CSV files, where each file contains a time-series. Each row in a CSV file is a time-step, each column is a feature. Thus, the whole file is a single multi-modal time-series. Also, if you want to use labels, it must be in a separated column of the CSV file and it should exists to all rows (time-steps). This layout is handled by the <code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code> class.</p></li>
<li><p>A single CSV file with a windowed time-series. Each row contains different modalities of the same windowed time-series. The prefix of the column names is used to identify the modalities. For instance, if the is <code class="docutils literal notranslate"><span class="pre">accel-x</span></code>, all columns that start with this prefix, like <code class="docutils literal notranslate"><span class="pre">accel-x-1</span></code>, <code class="docutils literal notranslate"><span class="pre">accel-x-2</span></code>, <code class="docutils literal notranslate"><span class="pre">accel-x-3</span></code>, are considered time-steps from the same modality (<code class="docutils literal notranslate"><span class="pre">accel-x</span></code>). Also, if you want to use labels, it must be in a separated column and it should exists to all rows, that is, for each
windowed multimodal time-series. This layout is handled by the <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code> class.</p></li>
</ul>
<p>We will show how to use these classes in the next sections.</p>
<section id="SeriesFolderCSVDataset">
<h3><code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code><a class="headerlink" href="#SeriesFolderCSVDataset" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code> class is designed to work with a directory containing several CSV files, where each file represent a time-series. Each row in a CSV file is a time-step, and each column is a feature.</p>
<p>This class assumes that data is organized in the following way, where <code class="docutils literal notranslate"><span class="pre">my_dataset</span></code> is the path to the directory containing the CSV files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>my_dataset/
<span class="w">    </span>series1.csv
<span class="w">    </span>series2.csv
<span class="w">    </span>other_series.csv
<span class="w">    </span>...
</pre></div>
</div>
<p>Where each CSV file represents a time-series, similar to the one below:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>accel-x</p></th>
<th class="head"><p>accel-y</p></th>
<th class="head"><p>accel-z</p></th>
<th class="head"><p>gyro-x</p></th>
<th class="head"><p>gyro-y</p></th>
<th class="head"><p>gyro-z</p></th>
<th class="head"><p>class</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0.502123</p></td>
<td><p>0.02123</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>0.682012</p></td>
<td><p>0.02123</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>0.498217</p></td>
<td><p>0.00001</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>0.12312</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>Note that the CSV must have a header with the column names. Also, columns that are not used as features or labels are ignored.</p>
<p>To handle this kind of data, we use the <code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code> class. This class is a Pytorch <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object that loads the data from the CSV files and makes it available to the model. Note that, each feature (column) represent a dimension of the time-series, while the rows represent the time-steps. The sample is a numpy array.</p>
<p>For this class, we must specify the following parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data_path</span></code>: the path to the directory containing the CSV files;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">features</span></code>: a list of strings with the names of the features columns, <em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">['accel-x',</span> <span class="pre">'accel-y',</span> <span class="pre">'accel-z',</span> <span class="pre">'gyro-x',</span> <span class="pre">'gyro-y',</span> <span class="pre">'gyro-z']</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code>: a string with the name of the label column, <em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">'class'</span></code>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ssl_tools.data.datasets</span> <span class="kn">import</span> <span class="n">SeriesFolderCSVDataset</span>

<span class="c1"># Path to the data</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;/workspaces/hiaac-m4/ssl_tools/data/view_concatenated/KuHar_cpc/train&quot;</span>

<span class="c1"># Creating the dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">SeriesFolderCSVDataset</span><span class="p">(</span>
    <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accel-x&quot;</span><span class="p">,</span> <span class="s2">&quot;accel-y&quot;</span><span class="p">,</span> <span class="s2">&quot;accel-z&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-x&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-y&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-z&quot;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;standard activity code&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1706883997.242541] [aae107fc745c:2264626:f]        vfs_fuse.c:281  UCX  ERROR inotify_add_watch(/tmp) failed: No space left on device
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SeriesFolderCSVDataset at /workspaces/hiaac-m4/ssl_tools/data/view_concatenated/KuHar_cpc/train (57 samples)
</pre></div></div>
</div>
<p>We can get the number of samples in the dataset with the <code class="docutils literal notranslate"><span class="pre">len</span></code> function, and we can retrive a sample with the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method, that is, using <code class="docutils literal notranslate"><span class="pre">[]</span></code>, such as <code class="docutils literal notranslate"><span class="pre">dataset[0]</span></code>. The dataset return type is different depending on the <code class="docutils literal notranslate"><span class="pre">label</span></code> parameter.</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">label</span></code> is speficied, the return type is a 2-element tuple, where the first element is a 2D numpy array with shape <code class="docutils literal notranslate"><span class="pre">(num_features,</span> <span class="pre">time_steps)</span></code>, and the second element is a 1D tensor with shape <code class="docutils literal notranslate"><span class="pre">(time_steps,)</span></code>.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">label</span></code> is not speficied, the return type is a single 2D numpy array with shape <code class="docutils literal notranslate"><span class="pre">(num_features,</span> <span class="pre">time_steps)</span></code>.</p></li>
</ul>
<p>Let’s check the number of samples and access the first sample and its label.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gte the length of the dataset</span>
<span class="n">length_of_dataset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length of dataset: </span><span class="si">{</span><span class="n">length_of_dataset</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Length of dataset: 57 samples
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the first sample. We can go from 0 to length_of_dataset - 1 (56)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">type_of_sample</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type of sample: </span><span class="si">{</span><span class="n">type_of_sample</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Type of sample: tuple with 2 elements
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The first element of the sample is the input, while the second element is the label</span>
<span class="c1"># We can split the sample into input and label variables</span>
<span class="n">shape_of_sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="n">shape_of_label</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of sample: </span><span class="si">{</span><span class="n">shape_of_sample</span><span class="si">}</span><span class="s2">, shape of label: </span><span class="si">{</span><span class="n">shape_of_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Shape of sample: (6, 2586), shape of label: (2586, 1)
</pre></div></div>
</div>
<p>You can see above, the sample is a 2-element tuple. The first element is a 2D numpy array with shape <code class="docutils literal notranslate"><span class="pre">(6,</span> <span class="pre">2586)</span></code>, and the second element is a 1D tensor with shape <code class="docutils literal notranslate"><span class="pre">(2586,)</span></code>, that is, a label for each time-step.</p>
</section>
<section id="MultiModalSeriesCSVDataset">
<h3><code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code><a class="headerlink" href="#MultiModalSeriesCSVDataset" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code> class is designed to work with a single CSV file containing a windowed time-series. Each row contains different modalities of the same windowed time-series. The prefix of the column names is used to identify the modalities. For instance, if the prefix is <code class="docutils literal notranslate"><span class="pre">accel-x</span></code>, all columns that start with this prefix, like <code class="docutils literal notranslate"><span class="pre">accel-x-1</span></code>, <code class="docutils literal notranslate"><span class="pre">accel-x-2</span></code>, <code class="docutils literal notranslate"><span class="pre">accel-x-3</span></code>, are considered time-steps from the same modality (<code class="docutils literal notranslate"><span class="pre">accel-x</span></code>). Also, if you want to use labels, it must
be in a separated column and it should exists to all rows, that is, for each windowed multimodal time-series.</p>
<p>The CSV file looks like this:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>accel-x-0</p></th>
<th class="head"><p>accel-x-1</p></th>
<th class="head"><p>accel-y-0</p></th>
<th class="head"><p>accel-y-1</p></th>
<th class="head"><p>class</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0.502123</p></td>
<td><p>0.02123</p></td>
<td><p>0.502123</p></td>
<td><p>0.502123</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0.6820123</p></td>
<td><p>0.02123</p></td>
<td><p>0.502123</p></td>
<td><p>0.502123</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>0.498217</p></td>
<td><p>0.00001</p></td>
<td><p>1.414141</p></td>
<td><p>3.141592</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>In the example, columns <code class="docutils literal notranslate"><span class="pre">accel-x-0</span></code> and <code class="docutils literal notranslate"><span class="pre">accel-x-1</span></code> are the <code class="docutils literal notranslate"><span class="pre">accel-x</span></code> feature at time <code class="docutils literal notranslate"><span class="pre">0</span></code> and time <code class="docutils literal notranslate"><span class="pre">1</span></code>, respectively. The same goes for the <code class="docutils literal notranslate"><span class="pre">accel-y</span></code> feature. Finally, the <code class="docutils literal notranslate"><span class="pre">class</span></code> column is the label. Columns that are not used as features or labels are ignored.</p>
<p>To use <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code>, we must specify the following parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data_path</span></code>: the path to the CSV file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">feature_prefixes</span></code>: a list of strings with the prefixes of the feature columns, e.g. <code class="docutils literal notranslate"><span class="pre">['accel-x',</span> <span class="pre">'accel-y']</span></code>. The class will look for columns with these prefixes and will consider them as features of a modality.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code>: a string with the name of the label column, e.g. <code class="docutils literal notranslate"><span class="pre">'class'</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">features_as_channels</span></code>: a boolean indicating if the features should be treated as channels, that is, if each prefix will become a channel. If <code class="docutils literal notranslate"><span class="pre">True</span></code>, the data will be returned as a vector of shape <code class="docutils literal notranslate"><span class="pre">(C,</span> <span class="pre">T)</span></code>, where C is the number of channels (features/prefixes) and <code class="docutils literal notranslate"><span class="pre">T</span></code> is the number of time steps. Else, the data will be returned as a vector of shape <code class="docutils literal notranslate"><span class="pre">T*C</span></code> (a single vector with all the features).</p></li>
</ul>
<p>Note that, each feature (column) represent a dimension of the time-series, while the rows represent the samples.</p>
<p>Let’s show how to read this data and create a <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code> object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ssl_tools.data.datasets</span> <span class="kn">import</span> <span class="n">MultiModalSeriesCSVDataset</span>

<span class="c1"># Path to the data</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;/workspaces/hiaac-m4/ssl_tools/data/standartized_balanced/KuHar/train.csv&quot;</span>

<span class="c1"># Instantiate the dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiModalSeriesCSVDataset</span><span class="p">(</span>
    <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
    <span class="n">feature_prefixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accel-x&quot;</span><span class="p">,</span> <span class="s2">&quot;accel-y&quot;</span><span class="p">,</span> <span class="s2">&quot;accel-z&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-x&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-y&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-z&quot;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;standard activity code&quot;</span><span class="p">,</span>
    <span class="n">features_as_channels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MultiModalSeriesCSVDataset at /workspaces/hiaac-m4/ssl_tools/data/standartized_balanced/KuHar/train.csv (1386 samples)
</pre></div></div>
</div>
<p>We can get the number of samples in the dataset with the <code class="docutils literal notranslate"><span class="pre">len</span></code> function, and we can retrive a sample with the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method, that is, using <code class="docutils literal notranslate"><span class="pre">[]</span></code>, such as <code class="docutils literal notranslate"><span class="pre">dataset[0]</span></code>. The dataset may return:</p>
<ul class="simple">
<li><p>A 2-element tuple, where the first element is a 2D numpy array with shape <code class="docutils literal notranslate"><span class="pre">(num_features,</span> <span class="pre">time_steps)</span></code>, and the second element is a 1D tensor with shape <code class="docutils literal notranslate"><span class="pre">(time_steps,)</span></code>.</p></li>
<li><p>A 2D numpy array with shape <code class="docutils literal notranslate"><span class="pre">(num_features,</span> <span class="pre">time_steps)</span></code>, if <code class="docutils literal notranslate"><span class="pre">label</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>, at the time of the dataset object’s creation.</p></li>
</ul>
<p>Let’s check the number of samples and access the first sample and its label.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">length_of_dataset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length of dataset: </span><span class="si">{</span><span class="n">length_of_dataset</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Length of dataset: 1386 samples
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">type_of_sample</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type of sample: </span><span class="si">{</span><span class="n">type_of_sample</span><span class="si">}</span><span class="s2"> with length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Type of sample: tuple with length 2 elements
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape_of_sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of sample: </span><span class="si">{</span><span class="n">shape_of_sample</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Shape of sample: (6, 60)
</pre></div></div>
</div>
</section>
</section>
<section id="Loading-batches-of-data-using-DataLoader">
<h2>Loading batches of data using DataLoader<a class="headerlink" href="#Loading-batches-of-data-using-DataLoader" title="Link to this heading"></a></h2>
<p>Pytorch models are trained using batches of data. Thus, we do not feed the model with a single sample at a time, but with a batch of samples. If we see the last example, the <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code> object returns a single sample at a time. Each sample is a 2-element tuple, where first element is a <code class="docutils literal notranslate"><span class="pre">(6,</span> <span class="pre">60)</span></code> numpy array and the second is an integer, representing the label.</p>
<p>A batch of samples add an extra dimension to the data. Thus, in our case, a batch of samples would be a 3D tensor, where the first dimension is the batch size (<code class="docutils literal notranslate"><span class="pre">B</span></code>), the second dimension is the number of features, or channels (<code class="docutils literal notranslate"><span class="pre">C</span></code>), and the third dimension is the number of time-steps (<code class="docutils literal notranslate"><span class="pre">T</span></code>). Thus, if the data have the shape <code class="docutils literal notranslate"><span class="pre">(6,</span> <span class="pre">60)</span></code>, a batch of 32 samples will be a tensor with shape <code class="docutils literal notranslate"><span class="pre">(32,</span> <span class="pre">6,</span> <span class="pre">60)</span></code>. The same happens to <code class="docutils literal notranslate"><span class="pre">label</span></code>, which gains an extra dimension, and would be an 1D tensor
with shape <code class="docutils literal notranslate"><span class="pre">(32,)</span></code>.</p>
<p>The batching of samples is done using a <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object. This object is a Pytorch object that takes a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object and returns batches of samples. The <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object is responsible for shuffling the data, dividing it into batches, and loading the data in parallel. Thus, given a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object, we can easilly create a <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object using the <code class="docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code> class.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="c1"># Create a DataLoader</span>
<span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dataloader</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;torch.utils.data.dataloader.DataLoader at 0x7f4dd2cb5960&gt;
</pre></div></div>
</div>
<p>Datasets implement the <code class="docutils literal notranslate"><span class="pre">__len__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> methods. However, the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object implements the iterable protocol, that is, it implements the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method, which returns an iterator to iterate over the data in batches. Thus, to fetch a batch of samples from the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object, we can use a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, as we do with any other iterable object in Python, like lists and tuples (<em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">batch</span> <span class="pre">in</span> <span class="pre">dataloader:</span> <span class="pre">...</span></code>). We can also use the <code class="docutils literal notranslate"><span class="pre">next</span></code> function to fetch
a single batch of samples, such as <code class="docutils literal notranslate"><span class="pre">batch</span> <span class="pre">=</span> <span class="pre">next(iter(dataloader))</span></code>. Let’s fetch a single sample from the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object and check its shape.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<span class="c1"># Batch is a tuple with two elements: inputs and labels.</span>
<span class="c1"># Let&#39;s extract it to two different variables</span>
<span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>
<span class="c1"># Print the shape of the inputs and labels</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inputs shape: </span><span class="si">{</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, labels shape: </span><span class="si">{</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Inputs shape: torch.Size([32, 6, 60]), labels shape: torch.Size([32])
</pre></div></div>
</div>
</section>
<section id="Handling-data-splits-(train,-validation,-and-test)-using-LightningDataModule">
<h2>Handling data splits (train, validation, and test) using <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code><a class="headerlink" href="#Handling-data-splits-(train,-validation,-and-test)-using-LightningDataModule" title="Link to this heading"></a></h2>
<p>Usually, we create a <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object for the training data, another for the validation data, and another for the test data. We can encapsulate the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> creation logic in a single place, and make it easy to use the same data processing logic across different experiments. A simple way to do this is to create a <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object is responsible for splitting the data into training, validation, and test sets, and creating the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> objects for each set. This object may also be responsible for setting up the data, such as downloading the data from the internet, checking the data, and add the augmentations.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object must implement four methods: <code class="docutils literal notranslate"><span class="pre">setup</span></code>, <code class="docutils literal notranslate"><span class="pre">train_dataloader</span></code>, <code class="docutils literal notranslate"><span class="pre">val_dataloader</span></code>, and <code class="docutils literal notranslate"><span class="pre">test_dataloader</span></code>. The <code class="docutils literal notranslate"><span class="pre">setup</span></code> is optional, and is responsible for splitting the data into training, validation, and test sets, and <code class="docutils literal notranslate"><span class="pre">train_dataloader</span></code>, <code class="docutils literal notranslate"><span class="pre">val_dataloader</span></code> and <code class="docutils literal notranslate"><span class="pre">test_dataloader</span></code> methods are responsible for creating the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> objects for the training, validation and test sets, respectively.</p>
<p>A data module may be implemented as shown below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lightning</span> <span class="k">as</span> <span class="nn">L</span>

<span class="k">class</span> <span class="nc">MyDataModule</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_csv_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_csv_path</span> <span class="o">=</span> <span class="n">train_csv_path</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span> <span class="ow">or</span> <span class="n">stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MultiModalSeriesCSVDataset</span><span class="p">(</span>
                <span class="n">data_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_csv_path</span><span class="p">,</span>
                <span class="n">feature_prefixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accel-x&quot;</span><span class="p">,</span> <span class="s2">&quot;accel-y&quot;</span><span class="p">,</span> <span class="s2">&quot;accel-z&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-x&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-y&quot;</span><span class="p">,</span> <span class="s2">&quot;gyro-z&quot;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;standard activity code&quot;</span><span class="p">,</span>
                <span class="n">features_as_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>When training a Pytorch Lightning model, we pass a <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object to the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> object, and the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> object is responsible calling the <code class="docutils literal notranslate"><span class="pre">setup</span></code>, <code class="docutils literal notranslate"><span class="pre">train_dataloader</span></code>, and <code class="docutils literal notranslate"><span class="pre">val_dataloader</span></code> methods, and for training the model.</p>
</section>
<section id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Link to this heading"></a></h2>
<p>First, we need to check which is our dataset and how the data is organized.</p>
<ul class="simple">
<li><p>If data is organized in a directory with several CSV files, we use the <code class="docutils literal notranslate"><span class="pre">SeriesFolderCSVDataset</span></code> class.</p></li>
<li><p>If data is organized in a single CSV file with a windowed time-series, we use the <code class="docutils literal notranslate"><span class="pre">MultiModalSeriesCSVDataset</span></code> class.</p></li>
</ul>
<p>Then, we create a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object, and use it to create a <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object.</p>
<p>In order to organize the creation of the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> object for each split (train, validation and test), we encapsule this logic in a <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object. The <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object is responsible for creating the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> objects for the training (<code class="docutils literal notranslate"><span class="pre">train_dataloader</span></code>), validation (<code class="docutils literal notranslate"><span class="pre">val_dataloader</span></code>), and test (<code class="docutils literal notranslate"><span class="pre">test_dataloader</span></code>) data, and for setting up the data.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">LightningDataModule</span></code> object is then used to train Pytorch Lightning models, which will call the <code class="docutils literal notranslate"><span class="pre">setup</span></code>, <code class="docutils literal notranslate"><span class="pre">train_dataloader</span></code>, and <code class="docutils literal notranslate"><span class="pre">val_dataloader</span></code> methods, corretly, as needed in the training/test process.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../tutorials.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="02_training_model.html" class="btn btn-neutral float-right" title="2. Training a Pytorch Lighning model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, H.IAAC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>